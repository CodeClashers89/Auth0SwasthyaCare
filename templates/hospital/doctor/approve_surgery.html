{% extends 'base.html' %}

{% block title %}Approve Surgery - SwasthyaCare{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Surgery Approval</h1>
    <p class="page-subtitle">Review and approve or reject this surgery request</p>
</div>

<div class="grid grid-2">
    <div class="card">
        <div class="card-header">Surgery Details</div>
        <div class="card-body">
            <div class="info-list">
                <div class="info-item">
                    <span class="info-label">Surgery Type:</span>
                    <span class="info-value"><strong>{{ surgery.surgery_type }}</strong></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Patient Name:</span>
                    <span class="info-value">{{ surgery.patient_name }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Date:</span>
                    <span class="info-value">{{ surgery.surgery_date }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Time:</span>
                    <span class="info-value">{{ surgery.start_time|time:"h:i A" }} - {{ surgery.end_time|time:"h:i A" }}</span>

                </div>
                <div class="info-item">
                    <span class="info-label">Requested By:</span>
                    <span class="info-value">{{ surgery.created_by.get_full_name }}</span>
                </div>
                {% if surgery.notes %}
                <div class="info-item">
                    <span class="info-label">Notes:</span>
                    <span class="info-value">{{ surgery.notes }}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Conflicting Appointments</div>
        <div class="card-body">
            {% if conflicting_appointments %}
            <div class="alert alert-warning">
                <strong>⚠️ Warning:</strong> There are {{ conflicting_appointments.count }} appointment(s) scheduled
                during this surgery time.
            </div>
            <ul class="info-list">
                {% for appointment in conflicting_appointments %}
                <li>
                    <div>
                        <strong>{{ appointment.patient.patient_id }}</strong> - {{
                        appointment.patient.user.get_full_name }}<br>
                        <small style="color: var(--text-secondary);">{{ appointment.appointment_time|time:"h:i A"
                            }}</small>
                    </div>
                </li>
                {% endfor %}
            </ul>
            <p class="mt-2"><small>You will need to reschedule these appointments if you approve this surgery.</small>
            </p>
            {% else %}
            <div class="alert alert-success">
                <strong>✅ No conflicts:</strong> No appointments are scheduled during this surgery time.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="card mt-3">
    <div class="card-header">Approval Decision</div>
    <div class="card-body">
        <form method="post">
            {% csrf_token %}

            <div class="form-group">
                <label>{{ form.status.label }}</label>
                {{ form.status }}
                {% if form.status.errors %}
                <div class="error-message">{{ form.status.errors }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="{{ form.rejection_reason.id_for_label }}">{{ form.rejection_reason.label }}</label>
                {{ form.rejection_reason }}
                <small class="form-help">{{ form.rejection_reason.help_text }}</small>
                {% if form.rejection_reason.errors %}
                <div class="error-message">{{ form.rejection_reason.errors }}</div>
                {% endif %}
            </div>

            {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {{ form.non_field_errors }}
            </div>
            {% endif %}

            <div class="flex-between mt-3">
                <a href="{% url 'hospital:view_pending_surgeries' %}" class="btn btn-secondary">Back</a>
                <button type="submit" class="btn btn-primary">Submit Decision</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}